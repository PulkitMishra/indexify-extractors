from typing import List, Union
from indexify_extractor_sdk import Content, Extractor, Feature
from pydantic import BaseModel
from transformers import pipeline
from utils.chunk_module import IndexifyTextSplitter
from langchain.text_splitter import RecursiveCharacterTextSplitter, MarkdownTextSplitter, LatexTextSplitter
import indexify_text_splitter

import time
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class InputParams(BaseModel):
    max_length: int = 130
    chunk_method: str = "indexify" # recursive, markdown, latex

class SummaryExtractor(Extractor):
    name = "tensorlake/llm-summary"
    description = "A LLM based summarization extractor."
    system_dependencies = []
    input_mime_types = ["text/plain"]

    def __init__(self):
        super().__init__()
        self.summarizer = pipeline("text-generation", model="h2oai/h2o-danube2-1.8b-chat", device_map="auto")

    def extract(self, content: Content, params = InputParams) -> List[Union[Feature, Content]]:
        contents = []
        full_summary = ""

        article = content.data.decode("utf-8")

        max_length = getattr(params, 'max_length', len(article)//4)
        chunk_method = getattr(params, 'chunk_method', 'indexify')

        start_time = time.perf_counter()
        if chunk_method == "recursive":
            text_splitter = RecursiveCharacterTextSplitter(chunk_size=512, chunk_overlap=20)
            docs = text_splitter.create_documents([article])
            article_chunks = [doc.page_content for doc in docs]
        elif chunk_method == "markdown":
            text_splitter = MarkdownTextSplitter(chunk_size=512, chunk_overlap=20)
            docs = text_splitter.create_documents([article])
            article_chunks = [doc.page_content for doc in docs]
        elif chunk_method == "latex":
            text_splitter = LatexTextSplitter(chunk_size=512, chunk_overlap=20)
            docs = text_splitter.create_documents([article])
            article_chunks = [doc.page_content for doc in docs]
        else:
            article_chunks = indexify_text_splitter.create_documents([article], 512)
            # text_splitter = IndexifyTextSplitter(chunk_size=512)
            # article_chunks = text_splitter.create_documents([article])
        
        end_time = time.perf_counter()
        split_duration = end_time - start_time
        split_duration_ms = split_duration * 1000
        logging.info(f"Text splitting took {split_duration_ms:.4f} milliseconds for method '{chunk_method}' with input size {len(article)} characters.")
        num_chunks = len(article_chunks)

        for item in article_chunks:
            messages = [
                {"role": "user", "content": f"Summarize this in {max_length//num_chunks} words: {item}"}
            ]
            prompt = self.summarizer.tokenizer.apply_chat_template(
                messages,
                tokenize=False,
                add_generation_prompt=True,
            )
            res = self.summarizer(
                prompt,
                max_new_tokens=(max_length//num_chunks)*1.5,
                return_full_text=False
            )
            summary = res[0]["generated_text"]
            full_summary = " ".join([full_summary, summary])

        feature = Feature.metadata(value={"original_length": len(article.split()), "summary_length": len(full_summary.split()), "num_chunks": num_chunks}, name="text")
        contents.append(Content.from_text(full_summary, features=[feature]))
        
        return contents

    def sample_input(self) -> Content:
        return Content.from_text("Hello world, I am a good boy.")

if __name__ == "__main__":
    # article = """New York (CNN)When Liana Barrientos was 23 years old, she got married in Westchester County, New York. A year later, she got married again in Westchester County, but to a different man and without divorcing her first husband. Only 18 days after that marriage, she got hitched yet again. Then, Barrientos declared "I do" five more times, sometimes only within two weeks of each other. In 2010, she married once more, this time in the Bronx. In an application for a marriage license, she stated it was her "first and only" marriage. Barrientos, now 39, is facing two criminal counts of "offering a false instrument for filing in the first degree," referring to her false statements on the 2010 marriage license application, according to court documents. Prosecutors said the marriages were part of an immigration scam. On Friday, she pleaded not guilty at State Supreme Court in the Bronx, according to her attorney, Christopher Wright, who declined to comment further. After leaving court, Barrientos was arrested and charged with theft of service and criminal trespass for allegedly sneaking into the New York subway through an emergency exit, said Detective Annette Markowski, a police spokeswoman. In total, Barrientos has been married 10 times, with nine of her marriages occurring between 1999 and 2002. All occurred either in Westchester County, Long Island, New Jersey or the Bronx. She is believed to still be married to four men, and at one time, she was married to eight men at once, prosecutors say. Prosecutors said the immigration scam involved some of her husbands, who filed for permanent residence status shortly after the marriages. Any divorces happened only after such filings were approved. It was unclear whether any of the men will be prosecuted. The case was referred to the Bronx District Attorney\'s Office by Immigration and Customs Enforcement and the Department of Homeland Security\'s Investigation Division. Seven of the men are from so-called "red-flagged" countries, including Egypt, Turkey, Georgia, Pakistan and Mali. Her eighth husband, Rashid Rajput, was deported in 2006 to his native Pakistan after an investigation by the Joint Terrorism Task Force. If convicted, Barrientos faces up to four years in prison.  Her next court appearance is scheduled for May 18."""
    article = """400 years ago, Galileo started piecing together the basic principles of reality—what we now call modern science. But the questions he was trying to answer are as old as humanity itself. What are we made of? What are the fundamental building blocks of the universe from which you, me, the stars, and everything else is constructed? In the centuries since Galileo, thousands of theories and experiments have peered into smaller and smaller distances... converging on a single picture of the structure of matter. This somewhat daunting-looking formula is where we end up. It gives the correct answer to hundreds of thousands of experiments, in some cases with an accuracy that is unprecedented in science. It is, by any measure, the most successful scientific theory of all time. And yet for something so extraordinary, we give it a rubbish name. We call it the Standard Model. I’m David Tong, a theoretical physicist at the University of Cambridge. And in this video, we’re going to build the Standard Model, piece by piece. By the end, I hope you’ll have some intuition for how all of the parts fit together to create the fundamental building blocks of our universe. This is the Standard Model. It describes how everything in the universe is made of 12 different types of matter particles, interacting with 3 forces, all bound together by a rather special particle called the Higgs boson. Before we get going, some caveats. First...I said “three forces”. While there are actually four fundamental forces... at play in the universe. This means that there’s something missing from this picture. That would be gravity, the most obvious force at play in the world around us and yet, in some sense, the one we understand least. We do have a theory of gravity, a very successful theory. It was given to us by Albert Einstein and goes by the name of general relativity. But there are two good reasons why it’s not included in the Standard Model. The first is that, at the microscopic level, the force of gravity is so weak that it barely has any effect on a single subatomic particle. The second is that we don’t really know how to incorporate general relativity, which is a classical theory, into the quantum world. We have no idea how to peer into a black hole where quantum gravity effects are at work. A second caveat is that the Standard Model is written in a language known as quantum field theory. This tells us that matter, at the fundamental level, is not really made up of particles. Instead, it’s made up of fields: fluid-like objects which are spread throughout all of space. These fields are engaged in an intricate, harmonious dance to a music that we call the laws of physics. The interactions between the fields produce the physical world in the form of particles. To understand the Standard Model, it’s more convenient to use the language of particles. As we build up the Standard Model, we’re going to meet lots of particles with an array of names that can very quickly become bewildering. But there is one classification that is, by far, the most important: Every particle is either a fermion, which is a matter particle, or a boson, which is a force particle. The distinction between fermions and bosons lies in the quantum world. Fermions must obey something called the Pauli exclusion principle. Roughly speaking, this means that you can’t put two fermions on top of each other in space. As such, these are the building blocks of matter. Bosons, on the other hand, can pile on top of each other as much as they want because they’re totally unconstrained by the Pauli exclusion principle. Bosons are the particles that mediate the forces and we’ll talk about them more later. For now, let’s start by looking at the fermions. Everything that we’re made of can be reduced to just three matter particles: an electron and two species of quarks, known as up and down quarks. The familiar proton and neutron each contain three quarks. The proton has two up quarks and a down, while the neutron has two down quarks and an up. Put protons and neutrons together, and you have a nucleus. Add electrons to the mix and you have an atom. Put a bunch of atoms together and that’s what you’re made of. All the beauty and complexity that we see in the world around us can be traced to this same collection of three particles, rearranged over and over in different combinations. Next comes the fourth type of matter particle. It’s called the neutrino and it’s not like the others. Neutrinos are extremely light and barely interact with anything else. For example, in the time it took me to say that, something like 100 trillion neutrinos passed through your body. Most of them came from the sun, but many of them have been streaming through the universe uninterrupted since the first few seconds after the Big Bang. So, there we have it: four matter particles. Three that make up you, me, and everyone we know, and one very peculiar cosmic ghost flowing through us all. Four is a nice simple number. But here’s where things start to get weird. Because Nature didn’t stop there. For reasons that we don’t understand, she took this collection of four particles and made two further copies. This means that there are actually three different kinds of electron-like particles. In addition to the original electron that we know and love, there are particles called the muon and the tau. The muon and the tau behave exactly like an electron, with one important exception: they’re heavier. The muon is about 200 times heavier than the electron, the tau almost three and a half thousand times heavier. The same generational pattern then repeats for the quarks. There are two heavier versions of the down quark, called strange and bottom quarks, and two heavier versions of the up quark, called charm and top. And then there are also two more neutrinos: we become slightly unimaginative in our naming and call the full collection the electron neutrino, the muon neutrino, and the tau neutrino. We don’t see the second and the third generations of particles in everyday life. We can create these heavier particles but they are unstable, which means that they quickly decay to the first generation of particles that we’re made of: the electron, up, or down quarks. Nonetheless, we know they exist. We can detect them in particle accelerators. In some cases, we’ve even been able to take photographs of the tracks they leave behind. So this is the collection of particles that makes up our world. Three sets of four. Now some of this we understand very well. In particular, we understand why particles have to come in a set of four. There is a mathematical consistency condition in the Standard Model that tells us that you can’t have one particle without the other three. In contrast, we have no idea why there are three generations rather than any other number. That’s a complete mystery. There’s a surprising aspect of mathematical unity here: all particles are described by exactly the same equation. This equation was written down in the 1920s by the physicist Paul Dirac, originally to describe the electron. But, as we discovered more and more particles -- quarks and neutrinos -- we realized that they too are described by the Dirac equation, or variants of it. In fact, we now know enough to be sure that if we found more matter particles, they too must be described by the Dirac equation. So, that’s the stuff we’re made of. But we’re still missing something crucial! And that’s the forces. Without the forces, the universe would be boring. All of the particles would wander around the cosmos like lost souls, never interacting, never doing anything interesting. There are three fundamental forces in the Standard Model and these allow us to explain what we see around us in the universe: electromagnetism, the strong force, and the weak force. Each of these forces comes with an associated particle. These particles are bosons, the other half of our particle family. Bosons are force-carrying particles. In one way of viewing things, you can think of the fermions as constantly swapping bosons between them, affecting their motion and giving rise to what we call a force. Let’s begin with the most familiar of these forces. Electromagnetism is responsible for the chemical properties of the elements and we’ve harnessed it to create much of modern technology. It acts on anything that carries electric charge. That means that it acts on the electron-type particles and the quarks, but not on the neutrinos because neutrinos are electrically neutral. An electron sitting in space will give rise to an electric field which spreads radially outwards, and attracts or repels any other electrically charged particle in its neighborhood. But if you look more closely at that electric field, you will find that it’s comprised of a collection of particles called photons. The next is the strongest fundamental force in nature, aptly named the strong force. This force acts only on quarks and, subsequently, on particles like protons and neutrons that are made of quarks. This is the force that holds together the nuclei of atoms. It’s also this force that is responsible for nuclear fission and gives the energy that is released in an atomic explosion. Just as the photon is associated to electromagnetism, there is a particle associated to the strong force. We call it the gluon because it literally sticks quarks together. Similarly, as the electron gives rise to an electric field, so a quark sitting in space will give rise to a gluon field. But something miraculous happens: unlike electromagnetism, the field doesn’t spread out radially. Instead, the quark produces a thin flux tube, a string-like object, which can only end when it finds a different kind of quark. This is what makes the strong force strong. Because the two quarks are joined by a flux tube, it takes more and more energy to pull them apart. This is why we never see quarks on their own. They’re always bound together by the strong force inside bigger particles like protons and neutrons. This is a phenomenon known as confinement. The third and final force is the most intricate and subtle of all the forces. This is the weak force. Like the strong force, the weak force only acts on subatomic distances. But rather than bind particles together, the weak force is all about decay. We just learned that the strong force binds quarks together to form protons and neutrons, creating the atomic nucleus. The weak force has the astonishing ability to allow quarks to switch their identity. For example, a down quark can turn into a up quark, releasing an electron and neutrino in the process. This means that a neutron can morph into a proton. This process is called radioactive beta decay. In this way, the weak force is responsible for the nuclear fusion reactions that power the sun and produce the energy required for life on Earth. Finally, the weak force is also the reason that heavier matter particles, like the muon and the strange quark, quickly decay into the three lighter and more stable fermions that make up matter as we know it. The weak force is the only one of the three forces to act on all the particles. In particular, it’s the only force that neutrinos feel. There are particles associated to the weak force and we call these the W and Z bosons. It’s finally time for us to meet the last piece of the jigsaw: the particle that in many ways ties the whole Standard Model together. This is the Higgs boson. To explain why the Higgs boson is special, I should first tell you a striking fact: none of the fundamental particles in the world have a mass. In fact, it’s worse than that: the equations of the Standard Model prohibit the particles from having any mass! Massless particles, like the photon are obliged to travel at the speed of light. So why don’t matter particles fly around, massless, at the speed of light? This is where the Higgs boson comes in. Its role is rather dramatic: it endows all fermions with a mass. The reason for this doesn’t have to do with the particle itself, but rather the Higgs field that permeates the universe. I’d love to be able to give you a clear explanation of why this happens, but sadly it’s difficult to come up with good analogies for the Higgs field. A so-so analogy is that you should view the Higgs field as something like a cosmic molasses, trapping matter particles as they travel through space and giving them a mass. We’ve known about the effects of the Higgs field for a long time. But experimental confirmation came only in 2012, when the Large Hadron Collider at CERN was able to smash protons together at high enough energies to cause a ripple in the Higgs field—a ripple that’s the particle that we call the Higgs boson. So this is the Standard Model: 12 matter particles, interacting with 3 forces and a Higgs field. It’s a beautiful picture, the pinnacle of 400 years of science. But it’s clear that this is not the last word in physics. Since the discovery of the Higgs boson, physicists like me feel that in many ways the Standard Model is too successful. It gives the right answer for pretty much every experiment that we can do. Our current hope is that we will eventually find an experiment that the Standard Model gives the wrong answer to. And there are some hints that this may be happening. Because only then can we get some clues about what lies beyond. One of the open questions about the model is whether the three fundamental forces are actually different, or whether they are a manifestation of a single all-encompassing force. This is the dream of a Grand Unified Theory. There are some theoretical signs that this may be the way things work, but no experimental confirmation. What Else Is Missing Of course, we’re also left with the obvious force that’s missing: gravity. At the beginning of the video, I talked about the problem of quantum gravity. In recent years we’ve discovered gravitational waves, which are ripples of space and time itself. And, if we look closely, there are good reasons to believe that these waves are made out of quantum particles called gravitons, just like light waves are made out of photons. But we’re a long way from discovering individual gravitons experimentally. There are other things missing from the Standard Model, too. It doesn’t include the invisible realm of dark matter and dark energy which means that we’re missing an explanation for a whopping 95% of the energy in the universe. Dark matter, for example, is almost certainly made up of additional particles that don’t interact with light. Perhaps these particles have their own forces and their own messenger bosons. Outro And there are still more questions about the Standard Model that we don’t know how to answer. Why is the muon 200 times heavier than the electron, while the top quark is almost 350,000 times heavier than the electron? Why are the neutrinos a million times lighter? We have no idea, and no way of predicting these masses other than by measuring them in experiments. But there are clearly patterns within these masses which strongly suggest that there is some underlying structure just waiting to be uncovered. The hope is that, with experimental results pointing the way, together with new theoretical ideas, we will ultimately be able to reveal the next layer of reality and understand what lies beyond the Standard Model. Until then, we continue Galileo’s journey, with the ultimate goal, a theoretical framework to explain the universe and everything in it: a theory of everything."""
    text_data = Content(content_type="text/plain", data=article)
    input_params = InputParams(max_length=150)
    extractor = SummaryExtractor()
    results = extractor.extract(text_data, params=input_params)
    print(results)